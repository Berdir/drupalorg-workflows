<!doctype html>
<html xmlns="http://www.w3.org/1999/html">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <title>Drupal.org Worflows</title>

  <link rel="stylesheet" href="dist/reset.css">
  <link rel="stylesheet" href="dist/reveal.css">
  <link rel="stylesheet" href="dist/theme/solarized.css">

  <!-- Theme used for syntax highlighted code -->
  <link rel="stylesheet" href="plugin/highlight/monokai.css">
  <style>
    .smaller {
      font-size: 30px;
    }
    .hljs-comment {
      color: lightskyblue;
    }
    li {
      margin-bottom: .5rem;
    }
  </style>
</head>
<body>
<div class="reveal">
  <div class="slides">
    <section><h1 class="r-fit-text">Drupal.org Workflows</h1><p><a href="https://berdir.github.io/drupalorg-workflows/">berdir.github.io/drupalorg-workflows/</a></p></section>
    <section>
      <h2>About me</h2>
      <ul>
        <li>Sascha Grossenbacher</li>
        <li>MD Systems (We're hiring!)</li>
        <li>https://drupal.org/u/berdir</li>
        <li>Entity system maintainer</li>
        <li>Contrib maintainer: TMGMT, Paragraphs, Token, Pathauto, Redirect, ...</li>
        <li>Contributing to Drupal since ~16 years</li>
      </ul>
    </section>
    <section><h2>Topics</h2>
      <ul>
        <li>Issues</li>
        <li>Patches & Merge Requests</li>
        <li>Gitlab CI</li>
        <li>Release Management</li>
      </ul>
    </section>
    <section>
      <h2>Disclaimer</h2>
      <ul>
        <li>Personal opinions ahead</li>
        <li>Not all maintainers work in the same way</li>
      </ul>
    </section>

    <section>
      <section><h2 class="r-fit-text">Issues</h2></section>
      <section>
        <img src="images/create_issue.png" alt="Screenshot of create new issue form">
      </section>
      <section>
        <h3>Overview</h3>
        <ul>
          <li>Issues use nodes and comments</li>
          <li>The node holds the issue metadata, updated through comments</li>
          <li>Mostly used to track code changes, consider using Slack, Forums, Drupal Answers, ... for support</li>
          <li>Different rules for Drupal core vs. contributed projects</li>
          <li>Search for existing issues first</li>
        </ul>
      </section>
      <section>
        <h3>Title</h3>
        <ul>
          <li>Short, compact description of the problem/feature</li>
          <li>Usually becomes the commit message if issue results in a code change</li>
        </ul>
      </section>
      <section>
        <h3>Priority</h3>
        <ul>
          <li>Only change to Major/Critical according to the rules</li>
          <li>Importance of the issue to the project, not to you</li>
          <li><a href="https://www.drupal.org/docs/develop/issues/fields-and-other-parts-of-an-issue/issue-priority-field">d.org/docs/develop/issues/fields-and-other-parts-of-an-issue/issue-priority-field</a></li>
        </ul>
      </section>
      <section>
        <h3>Status</h3>
        <ul>
          <li>Active: New issue, no work done yet</li>
          <li>Needs review: Patch/MR ready for review/testing</li>
          <li>Needs work: Updates needed after testing/reviewing</li>
          <li>Fixed: Set by maintainer after committing. Automatically changed to Closed (Fixed) after 2 weeks</li>
          <li><a href="https://www.drupal.org/docs/develop/issues/fields-and-other-parts-of-an-issue/issue-status-field">d.org/docs/develop/issues/fields-and-other-parts-of-an-issue/issue-status-field</a></li>
        </ul>
      </section>
      <section>
        <h3>Version</h3>
        <ul>
          <li>Always pick the development version/branch</li>
          <li>Contrib: Check project page when not sure</li>
        </ul>
        <img src="images/development_version.png" alt="The development version can usually be found in the releases section">
      </section>
      <section>
        <h3>Version (Drupal  Core)</h3>
        <ul>
          <li>Development in 11.x branch (=main branch)</li>
          <li>As of a few days ago, 10.3.x now exists as a separate branch</li>
          <li>Almost every issue should still target 11.x, will first be committed there</li>
          <li></li>
        </ul>
      </section>
      <section>
        <h3>Tags</h3>
        <ul>
          <li>Only standardized, documented tags should be used</li>
          <li>Common are for example Needs X, like Needs tests</li>
          <li><a href="https://www.drupal.org/node/3156530">drupal.org/node/3156530</a></li>
        </ul>
      </section>
      <section>
        <h3>Component</h3>
        <ul>
          <li>Drupal Core has component maintainers, so picking a matching component is important.</li>
          <li>Sometimes hard to find a good component, others will improve if necessary</li>
          <li>Most contrib projects barely use components</li>
        </ul>
      </section>
      <section>
        <h3>Assignee</h3>
        <ul>
          <li>Only maintainers can assign someone else than themselves</li>
          <li>Only assign to you if you are actively working on the issue, unassign when done</li>
        </ul>
      </section>
      <section>
        <h3>Issue summary</h3>
        <ul>
          <li>Use the template as much as possible</li>
          <li>Most important: Problem/Motivation, Steps to reproduce for a bug and proposed resolution.</li>
          <li>Updating issue summary of a large issue with many comments is a useful contribution!</li>
        </ul>
      </section>
      <section>
        <h3>Useful (non-code) contributions</h3>
        <ul>
          <li>Reproduce bugs, provide clear steps to reproduce when not provided</li>
          <li>Update issue summary</li>
          <li>Finding and reporting duplicates to prevent duplicate work</li>
          <li>Answer questions</li>
        </ul>
      </section>
      <section>
        <p>Issues will move to Gitlab</p>
      </section>
    </section>
    <section>
      <section><h2 class="r-fit-text">Patches & Merge Requests</h2></section>
      <section>
        <h3>Patches</h3>
        <ul>
          <li>Describe changes to source files</li>
          <li>Each patch contains full set of changes against the target branch</li>
          <li>Interdiff (diff between two patches) used to document incremental changes</li>
        </ul>
      </section>
      <section>
        <h3>Collaboration process with patches</h3>
        <ul>
          <li>Patch uploaded as an issue comment</li>
          <li>Review posted with requested changes</li>
          <li>Updated patch + interdiff uploaded as a comment</li>
          <li>Repeat until committed</li>
        </ul>
      </section>
      <section>
        <h3>Uncommon aspects on drupal.org</h3>
        <ul>
          <li>Very common that multiple developers contribute code to a single issue</li>
          <li>Custom tools like Dreditor</li>
          <li>Same basic workflow persisted for a very long time, while code versioning changed from CVS to Git to Gitlab</li>
          <li>High adoption of using patches in website projects (committed, drush make, composer patches)</li>
        </ul>
      </section>
      <section>
        <h3>Merge Requests (Pull Requests on Github)</h3>
        <ul>
          <li>Slow shift to merge requests, soon enforced due to DrupalCI/GitlabCI changes</li>
          <li>Similar basic process, but more structured</li>
          <li>Based on a git branch (patch) and commits (interdiff)</li>
          <li>Standard contribution process for many open source projects</li>
          <li>Easier to learn for non-Drupal developer and non-developer contributors</li>
        </ul>
      </section>
      <section>
        <h3>Limitation of Merge requests</h3>
        <ul>
          <li>Merge requests commonly assume a single developer/team</li>
          <li>Non-maintainers initiate process by creating a repository "fork" in their own name.</li>
          <li>Fork is owned by them, only they are commit</li>
        </ul>
      </section>
      <section>
        <h3>Merge requests on drupal.org</h3>
        <ul>
          <li>Custom process developed for drupal.org: shared issue forks</li>
          <li>First contributor requests an issue fork. Everyone can gain access, automatically granted</li>
          <li>Gitlab is working on a similar concept called <a href="https://about.gitlab.com/blog/2023/04/04/gitlab-community-forks/">Community forks</a></li>
        </ul>
      </section>
      <section>
        <h3>Create issue fork</h3>
        <img src="images/issue-fork-create.png" alt="Screenshot of Create issue fork UI on a drupal.org issue">
      </section>
      <section>
        <h3>Issue Fork info</h3>
        <img src="images/issue-fork-info.png" alt="Screenshot of Issue fork info widget">
      </section>
      <section>
        <h3>Issue Fork Commands</h3>
        <img src="images/issue-fork-commands.png" alt="Screenshot of Issue fork info widget with visible commands">
      </section>
      <section>
        <h3>Merge request UI</h3>
        <img src="images/merge-request-ui.png" alt="Screenshot of GitlabMerge request UI" >
      </section>
      <section>
        <h3>Merge request Code review</h3>
        <img src="images/merge-request-changes.png" alt="Screenshot of GitlabMerge request UI with a code review" >
      </section>
      <section>
        <h3>Using patches in your composer project</h3>
        <ul>
          <li><a href="https://github.com/cweagans/composer-patches">https://github.com/cweagans/composer-patches</a></li>
          <li><code>composer require cweagans/composer-patches</code></li>
        </ul>
      </section>
      <section>
        <h3>Recommended composer.json settings</h3>
        <pre><code class="language-json" data-line-numbers="2|3|4-6|7-11|13" data-trim>
          "extra": {
            "enable-patching": true,
            "composer-exit-on-patch-failure": true,
            "patchLevel": {
              "drupal/core": "-p2"
            },
            "patches": {
              "drupal/core": {
                "ISSUE-NR: DESCRIPTION": "PATCH-URL-OR-FILENAME",
              }
            }
            // OR
            "patches-file": "composer.patches.json",
          }
        </code></pre>
      </section>
      <section>
        <h3>Merge requests as patches</h3>
        <pre><code class="language-bash" data-line-numbers="" data-trim>
          curl -o patches/PROJECT-ISSUENR-description.patch \
          https://../merge_requests/5636.diff
        </code></pre>

        <h4>Important!</h4>
        <ol>
          <li>Do <strong>NOT</strong> use MR.diff URL directly. Remote Code Execution!</li>
          <li>Use .diff, not .patch (patch is a list of commits in a single patch)</li>
        </ol>
      </section>
      <section>
        <h3>Work on a merge request in your project for a contrib module</h3>
        <pre><code class="language-bash" data-line-numbers="1|2|3-5|6|7-8" data-trim>
          composer reinstall drupal/PROJECT --prefer-source
          cd web/modules/contrib/PROJECT
          git remote add ...
          git fetch ...
          git checkout ...
          ...
          git commit && push
          # Open Merge request (verify target branch), update issue
        </code></pre>

      </section>
    </section>
    <section>
      <section><h2 class="r-fit-text">Drupal CI to Gitlab CI</h2></section>
      <section>
        <h3>Drupal CI History</h3>
        <ul>
          <li>Several iterations, initially called PIFT (Project Issue File Test), around 2007</li>
          <li>Modernized around 2014 using Jenkins, Docker Containers to support different PHP and databases versions</li>
          <li>Limited flexibility</li>
          <li>Now deprecated, replaced with GitlabCI</li>
        </ul>
      </section>
      <section>
        <h3>Gitlab CI</h3>
        <ul>
          <li>Standard Continuous Integration system of Gitlab</li>
          <li>Pipeline: A set of jobs</li>
          <li>Jobs: Set of commands, runs in a container, can use N service containers (MySQL, Redis, ...), dependencies</li>
          <li>Scalable, runs on Kubernetes</li>
          <li>Infrastructure provided by Drupal Asssociation, pretty expensive, consider what pipelines are really needed</li>
        </ul>
      </section>
      <section>
        <p>CORE MR: test only, split</p>
      </section>
      <section>
        <h3>Add and use default template</h3>
        <img src="images/add-gitlab-ci.png" alt="Screenshot of add .gitlab-ci.yml file UI" >
      </section>
      <section>
        <h3>Default pipeline</h3>
        <img src="images/default-pipeline.png" alt="Screenshot of default Pipeline UI" >
        <p><a href="https://git.drupalcode.org/project/gitlab_templates">https://git.drupalcode.org/project/gitlab_templates</a></p>
      </section>
      <section>
        <h3>Investigate fails: Test results</h3>
        <img src="images/test-results.png" alt="Screenshot of Pipeline Test results" >
      </section>
      <section>
        <h3>Investigate fails: Artifacts</h3>
        <img src="images/test-artifacts.png" alt="Screenshot of PHPUnit Test Artifacts">
      </section>
      <section>
        <h3>Investigate fails: Artifacts</h3>
        <img src="images/test-artifacts-html.png" alt="Screenshot of PHPUnit Test Artifacts">
      </section>
      <section>
        <h3>Customize: Concurrent Test runs</h3>
        <p>Projects with more than a few tests: Use run-tests.sh with concurrency feature</p>
        <pre><code class="language-yaml" data-trim>
          variables:
            _PHPUNIT_CONCURRENT: '1'
        </code></pre>
      </section>
      <section>
        <h3>Customize: Test different Core and PHP versions</h3>
        <p>Use only what makes sense for your project</p>
        <pre><code class="language-yaml" data-trim>
          variables:
            OPT_IN_TEST_PREVIOUS_MAJOR: 1
            OPT_IN_TEST_PREVIOUS_MINOR: 1
            OPT_IN_TEST_NEXT_MINOR: 1
            OPT_IN_TEST_NEXT_MAJOR: 1
            OPT_IN_TEST_MAX_PHP: 1
        </code></pre>
        <p>Alternative #1: Scheduled Pipelines</p>
        <p>Alternative #2: Combine with manual execution</p>
        <pre><code class="language-yaml" data-trim>
          when: manual
        </code></pre>
      </section>
      <section>
        <h3>Scheduled Pipelines</h3>
        <img src="images/pipeline-schedule.png" alt="Screenshot of Pipeline Schedule Editor">
      </section>
      <section>
        <h3>Customize: Additional services</h3>
        <p>Redis needs a redis server</p>
        <pre><code class="language-yaml" data-trim>
          phpunit:
            services:
              - !reference [ .with-database ]
              - !reference [ .with-chrome ]
              - name: redis:6
        </code></pre>
      </section>
      <section>
        <h3>Customize: Composer dependencies and configuration</h3>
        <p>Everything in composer.json is merged into project composer.json</p>
        <pre><code class="language-json" data-trim>
            "name": "drupal/simplesamlphp_auth",
            "config": {
                "allow-plugins": {
                    "simplesamlphp/composer-module-installer": true
                }
            }
        </code></pre>
        <pre><code class="language-yaml" data-trim>
          .composer-base:
            before_script:
              - composer require --dev predis/predis --no-update
        </code></pre>
      </section>
      <section>
        <h3>Customize: Additional extensions/packages</h3>
        <p>Redis needs the redis php extension</p>
        <pre><code class="language-yaml" data-trim>
          phpunit:
            before_script:
              - pecl install redis && docker-php-ext-enable redis
        </code></pre>
        <p>Imagemagick needs extra packages</p>
        <pre><code class="language-yaml" data-trim>
            before_script:
              - sudo apt-get update
              - sudo apt-get install -y --no-install-recommends imagemagick
        </code></pre>
      </section>
      <section>
        <h3>Customize: Use your own image</h3>
        <p>Installing many packages and other system changes are slow. A separate image is faster, but needs to be maintained</p>
        <pre><code class="language-yaml" data-trim>
          default:
            image:
              name: berdir/php-8.3-apache-extra:production
        </code></pre>
        <pre><code class="language-yaml" data-trim>
          FROM drupalci/php-8.3-apache:production
          RUN apt-get update && apt-get install -y ...
          RUN pecl install redis && docker-php-ext-enable redis
        </code></pre>
      </section>
      <section>
        <h3>Customize: Install JS libraries</h3>
        <p>DropzoneJS needs the Dropzone JS library</p>
        <pre><code class="language-yaml" data-trim>
          variables:
            DROPZONE_VERSION: v5.9.3

          .composer-base:
            after_script:
              - mkdir $_WEB_ROOT/libraries
              - cd $_WEB_ROOT/libraries
              - curl -L -o dropzone.zip --silent
                https://github.com/dropzone/dropzone/releases/download/$DROPZONE_VERSION/dist.zip
              - unzip dropzone.zip
              - mv dist dropzone
        </code></pre>
      </section>
      <section>
        <h3>Customize: Test different version</h3>
        <p>DropzoneJS also wants to run tests with Dropzone v6</p>
        <pre><code class="language-yaml" data-trim>
          composer (dropzone 6):
            extends: .composer-base
            variables:
              DROPZONE_VERSION: v6.0.0-beta.2

          phpunit (dropzone 6):
            extends: phpunit
            needs:
              - "composer (dropzone 6)"
        </code></pre>
      </section>
      <section>
        <h3>Customize: Test Matrix</h3>
        <p>Redis tests run with redis and relay extension and phpredis</p>
        <pre><code class="language-yaml" data-trim>
          phpunit:
            parallel:
              matrix:
                - REDIS_INTERFACE:
                    - PhpRedis
                    - Predis
                    - Relay
        </code></pre>
      </section>
    </section>

  </div>
</div>

<script src="dist/reveal.js"></script>
<script src="plugin/notes/notes.js"></script>
<script src="plugin/markdown/markdown.js"></script>
<script src="plugin/highlight/highlight.js"></script>
<script>
  // More info about initialization & config:
  // - https://revealjs.com/initialization/
  // - https://revealjs.com/config/
  Reveal.initialize({
    hash: true,
    slideNumber: 'c/t',

    // Learn about plugins: https://revealjs.com/plugins/
    plugins: [RevealMarkdown, RevealHighlight, RevealNotes]
  });
</script>
</body>
</html>
